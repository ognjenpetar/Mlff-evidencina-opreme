<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLFF Data Migration Tool</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        body {
            padding: 40px;
            max-width: 1000px;
            margin: 0 auto;
        }
        .migration-container {
            background: var(--bg-card);
            padding: 30px;
            border-radius: var(--radius);
            border: 2px solid var(--primary-green);
        }
        h1 {
            color: var(--primary-green);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        h1 i {
            font-size: 2rem;
        }
        .warning-box {
            background: #ff990022;
            border: 2px solid #ff9900;
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
        }
        .warning-box h3 {
            color: #ff9900;
            margin-top: 0;
        }
        .info-box {
            background: var(--bg-input);
            padding: 15px;
            border-radius: var(--radius-small);
            margin: 15px 0;
        }
        .progress-container {
            margin-top: 30px;
            padding: 20px;
            background: var(--bg-input);
            border-radius: var(--radius);
            display: none;
        }
        .progress-container.active {
            display: block;
        }
        .progress-log {
            max-height: 400px;
            overflow-y: auto;
            background: var(--bg-dark);
            padding: 15px;
            border-radius: var(--radius-small);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .progress-log .success {
            color: var(--primary-green);
        }
        .progress-log .error {
            color: var(--danger);
        }
        .progress-log .info {
            color: var(--text-secondary);
        }
        .btn {
            margin: 10px 10px 0 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-item {
            background: var(--bg-input);
            padding: 15px;
            border-radius: var(--radius-small);
            text-align: center;
        }
        .stat-value {
            font-size: 2rem;
            color: var(--primary-green);
            font-weight: 700;
        }
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="migration-container">
        <h1>
            <i class="fas fa-database"></i>
            MLFF Data Migration Tool
        </h1>

        <div class="warning-box">
            <h3><i class="fas fa-exclamation-triangle"></i> VAŽNO UPOZORENJE</h3>
            <ul>
                <li>Pre pokretanja migracije, <strong>obavezno napravite backup</strong> trenutnih podataka!</li>
                <li>Koristite "Export Data" funkciju u glavnoj aplikaciji pre nego što nastavite.</li>
                <li>Ovaj proces će uploadovati sve podatke iz LocalStorage na Firebase.</li>
                <li>Migracija može potrajati nekoliko minuta zavisno od količine podataka.</li>
                <li>Ne zatvarajte stranicu dok migracija ne bude završena!</li>
            </ul>
        </div>

        <div class="info-box" id="localStorage Status">
            <h4><i class="fas fa-info-circle"></i> LocalStorage Status</h4>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="localLocations">0</div>
                    <div class="stat-label">Lokacija</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="localEquipment">0</div>
                    <div class="stat-label">Opreme</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="localDocuments">0</div>
                    <div class="stat-label">Dokumenata</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="localSize">0 KB</div>
                    <div class="stat-label">Veličina</div>
                </div>
            </div>
        </div>

        <div style="margin-top: 30px;">
            <button class="btn btn-primary btn-large" onclick="startMigration()" id="startBtn">
                <i class="fas fa-play"></i> Pokreni Migraciju
            </button>
            <button class="btn btn-secondary btn-large" onclick="checkLocalStorage()">
                <i class="fas fa-sync"></i> Osveži Status
            </button>
            <button class="btn btn-danger btn-large" onclick="clearLocalStorage()" id="clearBtn" style="display:none;">
                <i class="fas fa-trash"></i> Obriši LocalStorage (posle migracije)
            </button>
        </div>

        <div class="progress-container" id="progressContainer">
            <h3><i class="fas fa-spinner fa-spin"></i> Migracija u toku...</h3>
            <div class="progress-log" id="progressLog"></div>
        </div>
    </div>

    <script src="js/firebase-config.js"></script>
    <script>
        let migrationComplete = false;

        // Check LocalStorage on load
        window.onload = function() {
            checkLocalStorage();
        };

        function checkLocalStorage() {
            const stored = localStorage.getItem('mlff_data');

            if (!stored) {
                log('Nema podataka u LocalStorage.', 'error');
                document.getElementById('localLocations').textContent = '0';
                document.getElementById('localEquipment').textContent = '0';
                document.getElementById('localDocuments').textContent = '0';
                document.getElementById('localSize').textContent = '0 KB';
                document.getElementById('startBtn').disabled = true;
                return;
            }

            try {
                const data = JSON.parse(stored);
                const locations = data.locations || [];
                let equipmentCount = 0;
                let documentCount = 0;

                locations.forEach(loc => {
                    const equipment = loc.equipment || [];
                    equipmentCount += equipment.length;
                    equipment.forEach(eq => {
                        documentCount += (eq.documents || []).length;
                    });
                });

                const sizeKB = (stored.length / 1024).toFixed(2);

                document.getElementById('localLocations').textContent = locations.length;
                document.getElementById('localEquipment').textContent = equipmentCount;
                document.getElementById('localDocuments').textContent = documentCount;
                document.getElementById('localSize').textContent = `${sizeKB} KB`;

                log(`Pronađeno: ${locations.length} lokacija, ${equipmentCount} opreme, ${documentCount} dokumenata`, 'info');
            } catch (error) {
                log('Greška pri čitanju LocalStorage podataka: ' + error.message, 'error');
            }
        }

        async function startMigration() {
            const stored = localStorage.getItem('mlff_data');

            if (!stored) {
                alert('Nema podataka za migraciju!');
                return;
            }

            const confirmMsg = 'Da li ste sigurni da želite da pokrenete migraciju?\n\n' +
                              'VAŽNO: Proverite da li ste napravili backup podataka!\n\n' +
                              'Kliknite OK za nastavak.';

            if (!confirm(confirmMsg)) {
                return;
            }

            document.getElementById('progressContainer').classList.add('active');
            document.getElementById('startBtn').disabled = true;
            log('='.repeat(60), 'info');
            log('POČETAK MIGRACIJE', 'success');
            log('='.repeat(60), 'info');

            try {
                const data = JSON.parse(stored);
                await migrateData(data);
                migrationComplete = true;
                document.getElementById('clearBtn').style.display = 'inline-block';
                log('='.repeat(60), 'success');
                log('MIGRACIJA USPEŠNO ZAVRŠENA!', 'success');
                log('='.repeat(60), 'success');
                alert('Migracija je uspešno završena!\n\nMožete sada da koristite aplikaciju sa Firebase backend-om.');
            } catch (error) {
                log('KRITIČNA GREŠKA: ' + error.message, 'error');
                alert('Greška tokom migracije: ' + error.message);
            }
        }

        async function migrateData(oldData) {
            const locations = oldData.locations || [];

            log(`Počinjem migraciju ${locations.length} lokacija...`, 'info');

            for (let i = 0; i < locations.length; i++) {
                const location = locations[i];
                log(`[${i + 1}/${locations.length}] Migriram lokaciju: ${location.name}`, 'info');

                try {
                    // Upload location photo if it's Base64
                    let photoURL = null;
                    if (location.photo && location.photo.startsWith('data:')) {
                        log(`  Uploadujem fotografiju lokacije...`, 'info');
                        const blob = base64ToBlob(location.photo);
                        photoURL = await uploadBlob('locations', location.id, 'photo.jpg', blob);
                        log(`  ✓ Fotografija uploadovana`, 'success');
                    }

                    // Create location in Firestore
                    const locationData = {
                        name: location.name || '',
                        latitude: parseFloat(location.latitude) || 0,
                        longitude: parseFloat(location.longitude) || 0,
                        description: location.description || '',
                        photoURL: photoURL || null,
                        createdAt: firebase.firestore.Timestamp.now(),
                        updatedAt: firebase.firestore.Timestamp.now()
                    };

                    const locationRef = await db.collection('locations').add(locationData);
                    log(`  ✓ Lokacija kreirana u Firestore (ID: ${locationRef.id})`, 'success');

                    // Migrate equipment for this location
                    const equipment = location.equipment || [];
                    log(`  Migriram ${equipment.length} opreme za ovu lokaciju...`, 'info');

                    for (let j = 0; j < equipment.length; j++) {
                        const eq = equipment[j];
                        log(`    [${j + 1}/${equipment.length}] ${eq.inventoryNumber} (${eq.type})`, 'info');

                        try {
                            // Upload equipment photo
                            let eqPhotoURL = null;
                            if (eq.photo && eq.photo.startsWith('data:')) {
                                const blob = base64ToBlob(eq.photo);
                                eqPhotoURL = await uploadBlob('equipment', eq.id, 'photo.jpg', blob);
                                log(`      ✓ Fotografija opreme uploadovana`, 'success');
                            }

                            // Create equipment in Firestore
                            const equipmentData = {
                                locationId: locationRef.id,
                                inventoryNumber: eq.inventoryNumber || '',
                                type: eq.type || '',
                                status: eq.status || 'Aktivna',
                                ipAddress: eq.ipAddress || '',
                                macAddress: eq.macAddress || '',
                                xCoord: parseInt(eq.xCoord) || 0,
                                yCoord: parseInt(eq.yCoord) || 0,
                                zCoord: parseInt(eq.zCoord) || 0,
                                installDate: eq.installDate ? firebase.firestore.Timestamp.fromDate(new Date(eq.installDate)) : null,
                                warrantyExpiry: eq.warrantyExpiry ? firebase.firestore.Timestamp.fromDate(new Date(eq.warrantyExpiry)) : null,
                                installerName: eq.installerName || '',
                                testerName: eq.testerName || '',
                                photoURL: eqPhotoURL || null,
                                notes: eq.notes || '',
                                createdAt: firebase.firestore.Timestamp.now(),
                                updatedAt: firebase.firestore.Timestamp.now()
                            };

                            const equipmentRef = await db.collection('equipment').add(equipmentData);
                            log(`      ✓ Oprema kreirana (ID: ${equipmentRef.id})`, 'success');

                            // Migrate documents
                            const documents = eq.documents || [];
                            if (documents.length > 0) {
                                log(`      Uploadujem ${documents.length} dokumenata...`, 'info');
                                for (let k = 0; k < documents.length; k++) {
                                    const doc = documents[k];
                                    if (doc.data && doc.data.startsWith('data:')) {
                                        const blob = base64ToBlob(doc.data);
                                        const docURL = await uploadBlob('equipment', equipmentRef.id, doc.name, blob);

                                        await db.collection('equipment').doc(equipmentRef.id)
                                            .collection('documents').add({
                                                name: doc.name,
                                                url: docURL,
                                                storagePath: `equipment/${equipmentRef.id}/documents/${doc.name}`,
                                                type: doc.type || 'application/pdf',
                                                size: blob.size,
                                                uploadedAt: firebase.firestore.Timestamp.now()
                                            });

                                        log(`        ✓ Dokument ${k + 1}/${documents.length}: ${doc.name}`, 'success');
                                    }
                                }
                            }

                            // Migrate maintenance history
                            const maintenance = eq.maintenance || [];
                            if (maintenance.length > 0) {
                                log(`      Migriram ${maintenance.length} servisnih zapisa...`, 'info');
                                for (const maint of maintenance) {
                                    await db.collection('equipment').doc(equipmentRef.id)
                                        .collection('maintenance').add({
                                            type: maint.type || '',
                                            date: maint.date ? firebase.firestore.Timestamp.fromDate(new Date(maint.date)) : firebase.firestore.Timestamp.now(),
                                            servicerName: maint.servicerName || '',
                                            description: maint.description || '',
                                            cost: parseFloat(maint.cost) || 0,
                                            nextServiceDate: maint.nextServiceDate ? firebase.firestore.Timestamp.fromDate(new Date(maint.nextServiceDate)) : null,
                                            createdAt: firebase.firestore.Timestamp.now()
                                        });
                                }
                                log(`      ✓ Servisni zapisi migrirani`, 'success');
                            }

                            // Migrate audit log (history)
                            const history = eq.history || [];
                            if (history.length > 0) {
                                log(`      Migriram ${history.length} audit log zapisa...`, 'info');
                                for (const log of history) {
                                    await db.collection('equipment').doc(equipmentRef.id)
                                        .collection('auditLog').add({
                                            action: log.action || 'unknown',
                                            details: log.details || '',
                                            timestamp: log.timestamp ? firebase.firestore.Timestamp.fromDate(new Date(log.timestamp)) : firebase.firestore.Timestamp.now(),
                                            userId: 'migrated'
                                        });
                                }
                                log(`      ✓ Audit log zapisi migrirani`, 'success');
                            }

                        } catch (eqError) {
                            log(`      ✗ GREŠKA pri migraciji opreme: ${eqError.message}`, 'error');
                        }
                    }

                    log(`  ✓ Lokacija ${location.name} kompletno migirana`, 'success');
                } catch (locError) {
                    log(`  ✗ GREŠKA pri migraciji lokacije: ${locError.message}`, 'error');
                }
            }

            log('Sve lokacije migrirane!', 'success');
        }

        function base64ToBlob(base64) {
            const parts = base64.split(',');
            const contentType = parts[0].split(':')[1].split(';')[0];
            const raw = atob(parts[1]);
            const rawLength = raw.length;
            const uInt8Array = new Uint8Array(rawLength);

            for (let i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }

            return new Blob([uInt8Array], { type: contentType });
        }

        async function uploadBlob(collection, id, filename, blob) {
            const storageRef = storage.ref(`${collection}/${id}/${filename}`);
            await storageRef.put(blob);
            return await storageRef.getDownloadURL();
        }

        function log(message, type = 'info') {
            const logDiv = document.getElementById('progressLog');
            const timestamp = new Date().toLocaleTimeString('sr-RS');
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLocalStorage() {
            if (!migrationComplete) {
                alert('Prvo završite migraciju!');
                return;
            }

            const confirmMsg = 'Da li ste sigurni da želite da obrišete LocalStorage podatke?\n\n' +
                              'UPOZORENJE: Ovim ćete trajno ukloniti sve lokalne podatke!\n' +
                              'Proverite da li je migracija uspešno završena i da su podaci dostupni u Firebase-u.\n\n' +
                              'Kliknite OK za brisanje.';

            if (confirm(confirmMsg)) {
                localStorage.removeItem('mlff_data');
                localStorage.removeItem('mlff_custom_types');
                log('LocalStorage podaci obrisani.', 'success');
                alert('LocalStorage podaci su uspešno obrisani.\n\nMožete sada zatvoriti ovu stranicu.');
                checkLocalStorage();
            }
        }
    </script>
</body>
</html>
