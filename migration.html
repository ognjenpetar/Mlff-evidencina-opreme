<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migration Tool - LocalStorage to Supabase</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #764ba2;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .info-box {
            background: #f0f7ff;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
        }

        .info-box h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .info-box p {
            color: #555;
            line-height: 1.6;
        }

        .info-box ul {
            margin-top: 10px;
            margin-left: 20px;
            color: #555;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
        }

        .warning-box h3 {
            color: #ff9800;
            margin-bottom: 10px;
        }

        .btn {
            padding: 15px 40px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-block;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .progress-container {
            margin-top: 30px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .log-container {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-success {
            color: #4caf50;
        }

        .log-error {
            color: #f44336;
        }

        .log-info {
            color: #2196f3;
        }

        .log-warning {
            color: #ff9800;
        }

        .success-message {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            display: none;
        }

        .success-message h3 {
            color: #28a745;
            margin-bottom: 10px;
        }

        .error-message {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            display: none;
        }

        .error-message h3 {
            color: #dc3545;
            margin-bottom: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Migration Tool</h1>
        <p class="subtitle">LocalStorage ‚Üí Supabase Database Migration</p>

        <div class="info-box">
            <h3>‚ÑπÔ∏è About This Tool</h3>
            <p>This tool migrates your equipment tracking data from browser LocalStorage to Supabase cloud database.</p>
            <ul>
                <li>Converts LocalStorage JSON to PostgreSQL tables</li>
                <li>Uploads Base64 photos to Supabase Storage</li>
                <li>Preserves all relationships (locations ‚Üí equipment ‚Üí documents)</li>
                <li>Creates audit log entries for tracking</li>
            </ul>
        </div>

        <div class="warning-box">
            <h3>‚ö†Ô∏è Important</h3>
            <p><strong>Before starting:</strong></p>
            <ul>
                <li>Make sure Supabase credentials are configured in <code>js/supabase-config.js</code></li>
                <li>Run all SQL migrations in Supabase Dashboard (001, 002, 003, 004)</li>
                <li>Login with Google OAuth (admin account)</li>
                <li>This process may take 5-30 minutes depending on data size</li>
                <li><strong>DO NOT close this tab while migration is running!</strong></li>
            </ul>
        </div>

        <div id="stats-before" class="stats" style="display:none;">
            <div class="stat-box">
                <div class="stat-number" id="stat-locations">0</div>
                <div class="stat-label">Locations</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="stat-equipment">0</div>
                <div class="stat-label">Equipment</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="stat-documents">0</div>
                <div class="stat-label">Documents</div>
            </div>
        </div>

        <button id="startBtn" class="btn btn-primary" onclick="startMigration()">
            üöÄ Start Migration
        </button>

        <div id="progressContainer" class="progress-container">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill">0%</div>
            </div>
            <div class="log-container" id="logContainer"></div>
        </div>

        <div id="successMessage" class="success-message">
            <h3>‚úÖ Migration Completed Successfully!</h3>
            <p>All data has been migrated to Supabase.</p>
            <p><a href="index.html" style="color: #28a745; font-weight: 600;">Go to Application ‚Üí</a></p>
        </div>

        <div id="errorMessage" class="error-message">
            <h3>‚ùå Migration Failed</h3>
            <p id="errorText"></p>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>

    <script>
        let totalSteps = 0;
        let completedSteps = 0;

        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;

            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;

            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateProgress() {
            const percentage = totalSteps > 0 ? Math.round((completedSteps / totalSteps) * 100) : 0;
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = percentage + '%';
            progressFill.textContent = percentage + '%';
        }

        function base64ToBlob(base64) {
            const parts = base64.split(';base64,');
            const contentType = parts[0].split(':')[1];
            const raw = window.atob(parts[1]);
            const rawLength = raw.length;
            const uint8Array = new Uint8Array(rawLength);

            for (let i = 0; i < rawLength; i++) {
                uint8Array[i] = raw.charCodeAt(i);
            }

            return new Blob([uint8Array], { type: contentType });
        }

        async function uploadPhotoToSupabase(entityType, entityId, base64Data) {
            try {
                const blob = base64ToBlob(base64Data);
                const timestamp = Date.now();
                const filename = `${timestamp}_migrated_photo.jpg`;
                const bucket = entityType === 'location' ? 'location-photos' : 'equipment-photos';
                const storagePath = `${entityId}/${filename}`;

                const { error: uploadError } = await supabase.storage
                    .from(bucket)
                    .upload(storagePath, blob, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (uploadError) throw uploadError;

                const { data: urlData } = supabase.storage
                    .from(bucket)
                    .getPublicUrl(storagePath);

                return urlData.publicUrl;
            } catch (error) {
                console.error('Photo upload failed:', error);
                throw error;
            }
        }

        async function uploadDocumentToSupabase(equipmentId, documentData) {
            try {
                if (!documentData.data || !documentData.data.startsWith('data:')) {
                    log(`  ‚è≠Ô∏è Skipping document (not Base64): ${documentData.name}`, 'warning');
                    return;
                }

                const blob = base64ToBlob(documentData.data);
                const timestamp = Date.now();
                const filename = `${timestamp}_${documentData.name}`;
                const storagePath = `${equipmentId}/${filename}`;

                log(`  üì§ Uploading document: ${documentData.name}`, 'info');

                const { error: uploadError } = await supabase.storage
                    .from('equipment-documents')
                    .upload(storagePath, blob, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (uploadError) throw uploadError;

                const { data: urlData } = supabase.storage
                    .from('equipment-documents')
                    .getPublicUrl(storagePath);

                const { data: docData, error: dbError } = await supabase
                    .from('documents')
                    .insert([{
                        equipment_id: equipmentId,
                        name: documentData.name,
                        file_url: urlData.publicUrl,
                        storage_path: storagePath,
                        file_type: documentData.type || 'application/pdf',
                        file_size: blob.size
                    }])
                    .select()
                    .single();

                if (dbError) throw dbError;

                log(`  ‚úÖ Document uploaded: ${documentData.name}`, 'success');
                completedSteps++;
                updateProgress();
            } catch (error) {
                log(`  ‚ùå Document upload failed: ${documentData.name} - ${error.message}`, 'error');
                throw error;
            }
        }

        async function startMigration() {
            try {
                // Check if user is authenticated
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    alert('‚ö†Ô∏è You must be logged in to migrate data!\n\nPlease:\n1. Go to index.html\n2. Login with Google\n3. Come back to this page');
                    return;
                }

                // Disable button
                document.getElementById('startBtn').disabled = true;

                // Show progress container
                document.getElementById('progressContainer').style.display = 'block';

                log('üîç Checking for LocalStorage data...', 'info');

                // Get LocalStorage data
                const localDataStr = localStorage.getItem('mlff_data');
                if (!localDataStr) {
                    throw new Error('No data found in LocalStorage');
                }

                const localData = JSON.parse(localDataStr);
                const locations = localData.locations || [];

                if (locations.length === 0) {
                    throw new Error('No locations found in LocalStorage');
                }

                // Calculate total steps
                totalSteps = locations.length;
                locations.forEach(location => {
                    if (location.photo && location.photo.startsWith('data:')) totalSteps++;
                    const equipment = location.equipment || [];
                    totalSteps += equipment.length;
                    equipment.forEach(eq => {
                        if (eq.photo && eq.photo.startsWith('data:')) totalSteps++;
                        totalSteps += (eq.documents || []).length;
                        totalSteps += (eq.maintenance || []).length;
                    });
                });

                // Show stats
                const totalEquipment = locations.reduce((sum, loc) => sum + (loc.equipment?.length || 0), 0);
                const totalDocuments = locations.reduce((sum, loc) => {
                    return sum + (loc.equipment || []).reduce((eqSum, eq) => eqSum + (eq.documents?.length || 0), 0);
                }, 0);

                document.getElementById('stat-locations').textContent = locations.length;
                document.getElementById('stat-equipment').textContent = totalEquipment;
                document.getElementById('stat-documents').textContent = totalDocuments;
                document.getElementById('stats-before').style.display = 'grid';

                log(`üìä Found: ${locations.length} locations, ${totalEquipment} equipment, ${totalDocuments} documents`, 'info');
                log(`üéØ Total migration steps: ${totalSteps}`, 'info');
                log('', 'info');
                log('üöÄ Starting migration...', 'info');

                // Migrate each location
                for (const location of locations) {
                    log(`üìç Migrating location: ${location.name}`, 'info');

                    // Upload location photo if exists
                    let photoURL = null;
                    if (location.photo && location.photo.startsWith('data:')) {
                        log(`  üì∏ Uploading location photo...`, 'info');
                        photoURL = await uploadPhotoToSupabase('location', location.id || crypto.randomUUID(), location.photo);
                        log(`  ‚úÖ Location photo uploaded`, 'success');
                        completedSteps++;
                        updateProgress();
                    }

                    // Insert location into Supabase
                    const { data: newLocation, error: locError } = await supabase
                        .from('locations')
                        .insert([{
                            name: location.name,
                            latitude: parseFloat(location.latitude),
                            longitude: parseFloat(location.longitude),
                            address: location.address || null,
                            description: location.description || null,
                            photo_url: photoURL
                        }])
                        .select()
                        .single();

                    if (locError) throw locError;

                    log(`‚úÖ Location created in Supabase: ${newLocation.id}`, 'success');
                    completedSteps++;
                    updateProgress();

                    // Migrate equipment for this location
                    const equipment = location.equipment || [];
                    for (const eq of equipment) {
                        log(`  üîß Migrating equipment: ${eq.inventoryNumber}`, 'info');

                        // Upload equipment photo
                        let eqPhotoURL = null;
                        if (eq.photo && eq.photo.startsWith('data:')) {
                            log(`    üì∏ Uploading equipment photo...`, 'info');
                            eqPhotoURL = await uploadPhotoToSupabase('equipment', eq.id || crypto.randomUUID(), eq.photo);
                            log(`    ‚úÖ Equipment photo uploaded`, 'success');
                            completedSteps++;
                            updateProgress();
                        }

                        // Insert equipment
                        const { data: newEquipment, error: eqError } = await supabase
                            .from('equipment')
                            .insert([{
                                location_id: newLocation.id,
                                inventory_number: eq.inventoryNumber,
                                type: eq.type,
                                status: eq.status || 'Aktivna',
                                manufacturer: eq.manufacturer || null,
                                model: eq.model || null,
                                serial_number: eq.serialNumber || null,
                                ip_address: eq.ipAddress || null,
                                mac_address: eq.macAddress || null,
                                x_coord: parseInt(eq.xCoord) || 0,
                                y_coord: parseInt(eq.yCoord) || 0,
                                z_coord: parseInt(eq.zCoord) || 0,
                                installation_date: eq.installationDate || null,
                                installer_name: eq.installerName || null,
                                tester_name: eq.testerName || null,
                                warranty_expiry: eq.warrantyExpiry || null,
                                photo_url: eqPhotoURL,
                                notes: eq.notes || null
                            }])
                            .select()
                            .single();

                        if (eqError) throw eqError;

                        log(`  ‚úÖ Equipment created: ${newEquipment.id}`, 'success');
                        completedSteps++;
                        updateProgress();

                        // Migrate documents
                        const documents = eq.documents || [];
                        for (const doc of documents) {
                            await uploadDocumentToSupabase(newEquipment.id, doc);
                        }

                        // Migrate maintenance
                        const maintenance = eq.maintenance || [];
                        for (const maint of maintenance) {
                            await supabase
                                .from('maintenance')
                                .insert([{
                                    equipment_id: newEquipment.id,
                                    type: maint.type,
                                    date: maint.date,
                                    description: maint.description || null,
                                    performed_by: maint.performedBy || null,
                                    cost: maint.cost ? parseFloat(maint.cost) : null,
                                    next_service_date: maint.nextServiceDate || null
                                }]);

                            log(`    ‚úÖ Maintenance record migrated`, 'success');
                            completedSteps++;
                            updateProgress();
                        }
                    }

                    log('', 'info');
                }

                // Migration complete
                log('', 'info');
                log('üéâ Migration completed successfully!', 'success');
                document.getElementById('successMessage').style.display = 'block';

            } catch (error) {
                console.error('Migration error:', error);
                log('', 'info');
                log(`‚ùå Migration failed: ${error.message}`, 'error');
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorText').textContent = error.message;
            }
        }
    </script>
</body>
</html>
